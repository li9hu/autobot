<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务详情 - {{.task.Name}}</title>
    <script src="/static/js/tailwind.js"></script>
    <script src="/static/js/alpinejs.min.js" defer></script>
    <!-- Lucide Icons -->
    <script src="/static/js/lucide.js"></script>
    <script src="/static/js/app.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                    </div>
                    <h1 class="text-xl font-semibold text-slate-900">AutoBot</h1>
                </div>
                <div class="hidden sm:flex space-x-8">
                    <a href="/" class="text-slate-600 hover:text-slate-900 font-medium pb-4 px-1 border-b-2 border-transparent hover:border-slate-300 transition-colors">任务管理</a>
                    <a href="/logs" class="text-slate-600 hover:text-slate-900 font-medium pb-4 px-1 border-b-2 border-transparent hover:border-slate-300 transition-colors">执行日志</a>
                    <a href="/bark" class="text-slate-600 hover:text-slate-900 font-medium pb-4 px-1 border-b-2 border-transparent hover:border-slate-300 transition-colors">Bark管理</a>
                </div>
                <!-- Mobile menu button -->
                <div class="sm:hidden">
                    <button id="mobile-menu-button" class="p-2 rounded-md text-slate-400 hover:text-slate-500 hover:bg-slate-100">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <!-- Mobile menu -->
            <div id="mobile-menu" class="sm:hidden hidden border-t border-slate-200 py-3">
                <a href="/" class="block px-3 py-2 text-slate-600 hover:text-slate-900">任务管理</a>
                <a href="/logs" class="block px-3 py-2 text-slate-600 hover:text-slate-900">执行日志</a>
                <a href="/bark" class="block px-3 py-2 text-slate-600 hover:text-slate-900">Bark管理</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8" x-data="taskDetail()" x-init="init()">
        <!-- 面包屑导航 -->
        <div class="mb-6">
            <nav class="flex items-center space-x-4 text-sm text-gray-600">
                <a href="/" class="hover:text-blue-600">任务管理</a>
                <span>/</span>
                <span class="text-gray-900">任务详情</span>
            </nav>
        </div>

        <!-- 任务基本信息 -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-gray-900" x-text="task.name"></h1>
                <div class="flex items-center space-x-2">
                    <span class="px-3 py-1 rounded-full text-sm font-medium"
                          :class="task.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                          x-text="task.status === 'active' ? '运行中' : '已停止'"></span>
                    <button @click="runTask" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        立即执行
                    </button>
                </div>
            </div>
            <p class="text-gray-600 mb-4" x-text="task.description"></p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <span class="font-medium text-gray-700">Cron 表达式:</span>
                    <span class="ml-2 font-mono bg-gray-100 px-2 py-1 rounded" x-text="task.cron_expr"></span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">最后执行:</span>
                    <span class="ml-2" x-text="formatDate(task.last_run)"></span>
                </div>
                <div>
                    <span class="font-medium text-gray-700">下次执行:</span>
                    <span class="ml-2" x-text="formatDate(task.next_run)"></span>
                </div>
            </div>
        </div>

        <!-- 标签页 -->
        <div class="bg-white rounded-lg shadow-sm border">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button @click="activeTab = 'logs'" 
                            :class="activeTab === 'logs' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        执行日志
                    </button>
                    <button @click="activeTab = 'edit'" 
                            :class="activeTab === 'edit' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        编辑任务
                    </button>
                    <button @click="activeTab = 'bark'" 
                            :class="activeTab === 'bark' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        Bark 通知
                    </button>
                </nav>
            </div>

            <!-- 执行日志标签页 -->
            <div x-show="activeTab === 'logs'" x-cloak class="p-6">
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">执行日志</h3>
                    <div class="flex space-x-2">
                        <button @click="deleteTaskLogs" class="inline-flex items-center gap-2 px-3 py-1.5 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-colors text-sm font-medium">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            删除日志
                        </button>
                        <button @click="loadLogs" class="inline-flex items-center gap-2 px-3 py-1.5 border border-slate-300 rounded-lg bg-white text-slate-700 hover:bg-slate-50 transition-colors text-sm font-medium">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            刷新
                        </button>
                    </div>
                </div>
                
                <!-- 日志容器 -->
                <div id="taskLogsContainer" class="space-y-0 border rounded-lg bg-white">
                    <!-- 加载状态 -->
                    <div x-show="logsLoading" class="flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <span class="ml-3 text-slate-600">正在加载执行日志...</span>
                    </div>
                    
                    <!-- 无日志状态 -->
                    <div x-show="!logsLoading && logs.length === 0" class="text-center py-12">
                        <div class="w-16 h-16 mx-auto mb-4 bg-slate-100 rounded-full flex items-center justify-center">
                            <i data-lucide="file-text" class="w-8 h-8 text-slate-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-900 mb-2">暂无日志</h3>
                        <p class="text-slate-600">该任务还没有执行日志</p>
                    </div>
                    
                    <!-- 日志列表 -->
                    <div x-show="!logsLoading && logs.length > 0">
                        <template x-for="log in logs" :key="log.id">
                            <div class="border-b border-slate-200 p-4 hover:bg-slate-50 transition-colors last:border-b-0">
                                <!-- 日志头部信息 -->
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-1 rounded text-xs font-medium"
                                              :class="log.status === 'success' ? 'bg-green-100 text-green-800' : 
                                                     log.status === 'execution_failed' ? 'bg-red-100 text-red-800' :
                                                     log.status === 'script_failed' ? 'bg-orange-100 text-orange-800' :
                                                     log.status === 'failed' ? 'bg-red-100 text-red-800' : 
                                                     'bg-yellow-100 text-yellow-800'"
                                              x-text="log.status === 'success' ? '成功' : 
                                                     log.status === 'execution_failed' ? '执行失败' :
                                                     log.status === 'script_failed' ? '脚本错误' :
                                                     log.status === 'failed' ? '失败' : '运行中'"></span>
                                        <span class="text-sm text-slate-600" x-text="formatDate(log.start_time)"></span>
                                    </div>
                                    <div class="text-xs text-slate-500">
                                        ID: <span x-text="log.id"></span> | 执行时长: <span x-text="formatDuration(log.duration)"></span>
                                    </div>
                                </div>
                                
                                <!-- 标准输出 -->
                                <div x-show="log.output" class="mb-3">
                                    <div class="text-sm font-medium text-slate-700 mb-2 flex items-center">
                                        <i data-lucide="terminal" class="w-4 h-4 mr-2 text-green-600"></i>
                                        标准输出
                                    </div>
                                    <div class="bg-slate-900 text-green-400 p-3 rounded-lg font-mono text-sm overflow-auto max-h-60 border border-slate-700 log-output-scrollable log-output-dark">
                                        <pre class="whitespace-pre-wrap break-words" x-html="escapeHtmlWithNewlines(log.output)"></pre>
                                    </div>
                                </div>
                                
                                <!-- 错误输出 -->
                                <div x-show="log.error" class="mb-3">
                                    <div class="text-sm font-medium text-slate-700 mb-2 flex items-center">
                                        <i data-lucide="alert-triangle" class="w-4 h-4 mr-2 text-red-600"></i>
                                        错误输出
                                    </div>
                                    <div class="bg-red-50 border border-red-200 text-red-800 p-3 rounded-lg font-mono text-sm overflow-auto max-h-60 log-output-scrollable">
                                        <pre class="whitespace-pre-wrap break-words" x-html="escapeHtmlWithNewlines(log.error)"></pre>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- 分页 -->
                <nav x-show="!logsLoading && totalPages > 1" class="mt-6">
                    <div class="flex justify-center">
                        <div class="flex items-center space-x-1">
                            <!-- 上一页 -->
                            <button @click="changePage(currentPage - 1)" 
                                    :disabled="currentPage <= 1"
                                    :class="currentPage <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-100'"
                                    class="px-3 py-2 text-sm text-slate-600 rounded-lg transition-colors">
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            
                            <!-- 页码 -->
                            <template x-for="page in pageNumbers" :key="page">
                                <button @click="changePage(page)"
                                        :class="page === currentPage ? 'bg-blue-600 text-white' : 'text-slate-600 hover:bg-slate-100'"
                                        class="px-3 py-2 text-sm rounded-lg transition-colors min-w-[40px]"
                                        x-text="page"></button>
                            </template>
                            
                            <!-- 下一页 -->
                            <button @click="changePage(currentPage + 1)" 
                                    :disabled="currentPage >= totalPages"
                                    :class="currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-100'"
                                    class="px-3 py-2 text-sm text-slate-600 rounded-lg transition-colors">
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Bark 通知标签页 -->
            <div x-show="activeTab === 'bark'" x-cloak class="p-6">
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Bark 通知配置</h3>
                    <p class="text-sm text-gray-600">配置 Bark 推送通知，支持使用 $字段名 作为占位符引用任务执行结果中的数据</p>
                </div>

                <!-- 可用 Keys 展示 -->
                <div x-show="barkKeys.keys && barkKeys.keys.length > 0" class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
              
                        <div class="flex flex-wrap gap-2">
                        <template x-for="key in barkKeys.keys" :key="key">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-300 hover:bg-blue-200 transition-colors cursor-pointer">
                                <span class="font-mono font-semibold" x-text="'$' + key"></span>
                                    <button @click="copyToClipboard('$' + key, $event)" class="ml-2 text-blue-600 hover:text-green-800">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 002 2z"></path>
                                        </svg>
                                    </button>
                                </span>
                            </template>
                        </div>
                    <div class="text-xs text-blue-600 mt-2">
                        这些 Keys 来自任务的实际执行结果，点击可复制到剪贴板
                    </div>
                </div>

                <!-- 无可用 Keys 时的提示 -->
                <div x-show="!barkKeys.keys || barkKeys.keys.length === 0" class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-sm text-yellow-700">
                            <div class="font-medium mb-1">暂无可用的占位符 Keys</div>
                            <div class="text-xs">
                                • 请先执行任务，系统将自动从执行结果中提取可用的 Keys<br>
                                • 确保 Python 脚本返回 JSON 格式的结果，例如：<br>
                                  <code class="bg-yellow-100 px-1 rounded">print({"title": "...", "body": "..."})</code><br>
                                • 执行成功后，这里将显示所有可用的 Keys 供您使用
                            </div>
                        </div>
                    </div>
                </div>

                <form @submit.prevent="saveBarkConfig" class="space-y-4">
                    <!-- 推送设备和消息内容 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- 设备选择卡片 -->
                        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-4">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="smartphone" class="w-4 h-4 text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">推送设备</h3>
                                    <p class="text-sm text-gray-500">选择接收通知的设备</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex flex-wrap gap-3">
                                    <template x-for="device in availableDevices" :key="device.id">
                                        <label class="relative cursor-pointer">
                                            <input type="checkbox" 
                                                   :value="device.id"
                                                   x-model="selectedDeviceIds"
                                                   class="sr-only peer">
                                            <div class="flex items-center gap-2 px-4 py-2.5 bg-transparent border border-gray-200 rounded-xl text-sm font-medium text-gray-700 transition-all duration-200 peer-checked:bg-blue-800 peer-checked:border-blue-800 peer-checked:text-white hover:bg-gray-50 peer-checked:hover:bg-blue-900">
                                                <div class="w-2 h-2 rounded-full bg-gray-400 peer-checked:bg-white transition-colors"></div>
                                                <span x-text="device.name"></span>
                                                <span x-show="device.is_default" class="px-1.5 py-0.5 text-xs bg-white text-blue-700 rounded-md peer-checked:bg-blue-200 peer-checked:text-blue-900">默认</span>
                                            </div>
                                        </label>
                                    </template>
                                </div>
                                
                                <div x-show="availableDevices.length === 0" class="text-center py-6 text-gray-500 bg-gray-50 rounded-xl border border-gray-200">
                                    <i data-lucide="smartphone-nfc" class="w-6 h-6 text-gray-400 mx-auto mb-2"></i>
                                    <p class="text-sm font-medium mb-2">暂无可用设备</p>
                                    <a href="/bark" class="text-blue-600 hover:text-blue-700 text-sm font-medium">前往设备管理添加设备 →</a>
                                </div>
                                
                                <p class="text-xs text-gray-500 bg-gray-50 rounded-lg p-3">
                                    <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                    选择一个或多个设备进行推送，多选时将批量发送
                                </p>
                            </div>
                        </div>

                        <!-- 消息内容卡片 -->
                        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-4">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="message-square" class="w-4 h-4 text-green-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">消息内容</h3>
                                    <p class="text-sm text-gray-500">配置通知的标题和内容</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">推送标题</label>
                                    <input type="text" x-model="barkConfig.title" 
                                           class="flex-1 px-2.5 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors"
                                           placeholder="">
                                </div>
                                
                                <div class="flex items-center">
                                    <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">副标题</label>
                                    <input type="text" x-model="barkConfig.subtitle" 
                                           class="flex-1 px-2.5 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors"
                                           placeholder="">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">推送内容</label>
                                    <textarea x-model="barkConfig.body" rows="4"
                                              class="w-full px-2.5 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors resize-y min-h-[80px] max-h-[200px]"
                                              placeholder="$data 或固定文本&#10;支持多行文本和占位符"></textarea>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                <p class="text-xs text-blue-700 flex items-start gap-2">
                                    <i data-lucide="lightbulb" class="w-3 h-3 mt-0.5 flex-shrink-0"></i>
                                    <span>支持占位符：使用 $fieldname 格式可以动态插入任务执行结果中的字段值</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 显示设置、高级配置和去重配置 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- 显示设置 -->
                        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-4">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="settings" class="w-4 h-4 text-purple-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">显示设置</h3>
                                    <p class="text-sm text-gray-500">配置通知的外观和行为</p>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">中断级别</label>
                                    <select x-model="barkConfig.level" 
                                            class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors">
                                        <option value="">默认</option>
                                        <option value="critical">critical</option>
                                        <option value="active">active</option>
                                        <option value="timeSensitive">timeSensitive</option>
                                        <option value="passive">passive</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-center">
                                    <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">通知分组</label>
                                    <input type="text" x-model="barkConfig.group" 
                                           class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors"
                                           placeholder="分组名称">
                                </div>
                                
                                <div class="flex items-center">
                                    <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">角标数字</label>
                                    <input type="number" x-model="barkConfig.badge" 
                                           class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors"
                                           placeholder="1" min="0">
                                </div>
                                
                                <div class="flex items-center">
                                    <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">自定义图标</label>
                                    <input type="url" x-model="barkConfig.icon" 
                                           class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors"
                                           placeholder="图标 URL">
                                </div>
                            </div>
                            
                            <div class="mt-4 p-3 bg-purple-50 rounded-lg border border-purple-100">
                                <p class="text-xs text-purple-700">
                                    <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                    <strong>中断级别：</strong> critical(静音也响) • active(立即亮屏) • timeSensitive(专注可显示) • passive(仅列表)
                                </p>
                            </div>
                        </div>

                        <!-- 高级配置 -->
                        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-4">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="sliders" class="w-4 h-4 text-orange-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">高级配置</h3>
                                    <p class="text-sm text-gray-500">声音、复制和跳转设置</p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <!-- 声音设置 -->
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                                        <i data-lucide="volume-2" class="w-4 h-4 text-orange-600"></i>
                                        声音设置
                                    </h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">铃声</label>
                                            <select x-model="barkConfig.sound" 
                                                    class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors">
                                                <option value="">默认</option>
                                                <option value="alarm.caf">闹钟</option>
                                                <option value="bell.caf">铃声</option>
                                                <option value="chime.caf">钟声</option>
                                                <option value="electronic.caf">电子</option>
                                                <option value="glass.caf">玻璃</option>
                                                <option value="horn.caf">喇叭</option>
                                                <option value="newmail.caf">新邮件</option>
                                                <option value="silence.caf">静音</option>
                                                <option value="update.caf">更新</option>
                                            </select>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">音量</label>
                                            <input type="number" x-model="barkConfig.volume" 
                                                   class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors"
                                                   placeholder="5" min="0" max="10">
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">重复播放</label>
                                            <select x-model="barkConfig.call" 
                                                    class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors">
                                                <option value="">关闭</option>
                                                <option value="1">开启</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 交互设置 -->
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                                        <i data-lucide="external-link" class="w-4 h-4 text-orange-600"></i>
                                        交互设置
                                    </h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">自动复制</label>
                                            <select x-model="barkConfig.autoCopy" 
                                                    class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors">
                                                <option value="">关闭</option>
                                                <option value="1">开启</option>
                                            </select>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">点击动作</label>
                                            <select x-model="barkConfig.action" 
                                                    class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors">
                                                <option value="">默认</option>
                                                <option value="none">无动作</option>
                                            </select>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">复制内容</label>
                                            <input type="text" x-model="barkConfig.copy" 
                                                   class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors"
                                                   placeholder="指定复制内容">
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <label class="text-sm font-medium text-gray-700 w-20 flex-shrink-0">跳转链接</label>
                                            <input type="url" x-model="barkConfig.url" 
                                                   class="flex-1 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors"
                                                   placeholder="https://example.com">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 去重配置 -->
                        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-4">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="filter" class="w-4 h-4 text-red-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">去重配置</h3>
                                    <p class="text-sm text-gray-500">防止发送重复的通知内容</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <!-- 第一行：启用去重开关 + 去重模式 + 时间窗口 -->
                                <div class="flex items-center gap-3 flex-wrap">
                                    <!-- 启用去重开关 -->
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm font-medium text-gray-700">启用去重</label>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" x-model="barkConfig.deduplication.enabled" class="sr-only peer">
                                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                    
                                    <!-- 去重模式选择 -->
                                    <div x-show="barkConfig.deduplication.enabled" class="flex items-center gap-2">
                                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">模式</label>
                                        <select x-model="barkConfig.deduplication.mode" 
                                                class="px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors w-24">
                                            <option value="recentN">最近N条</option>
                                            <option value="hash">内容哈希</option>
                                            <option value="timeWindow">时间窗口</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 最近N条记录配置 -->
                                    <div x-show="barkConfig.deduplication.enabled && barkConfig.deduplication.mode === 'recentN'" class="flex items-center gap-2">
                                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">检查</label>
                                        <input type="number" x-model="barkConfig.deduplication.recent_n" 
                                               min="1" max="100" 
                                               class="w-16 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors">
                                        <span class="text-sm text-gray-500">条</span>
                                    </div>
                                    
                                    <!-- 时间窗口配置 -->
                                    <div x-show="barkConfig.deduplication.enabled && barkConfig.deduplication.mode === 'timeWindow'" class="flex items-center gap-2">
                                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">窗口</label>
                                        <input type="number" x-model="barkConfig.deduplication.time_window" 
                                               min="1" max="525600"
                                               class="w-20 px-2.5 py-1.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-colors">
                                        <span class="text-sm text-gray-500">分钟</span>
                                    </div>
                                </div>
                                
                                <!-- 模式说明 -->
                                <div x-show="barkConfig.deduplication.enabled" class="text-xs text-gray-500">
                                    <span x-show="barkConfig.deduplication.mode === 'recentN'">检查最近N条记录中是否有相同内容</span>
                                    <span x-show="barkConfig.deduplication.mode === 'hash'">检查全局是否有完全相同的内容</span>
                                    <span x-show="barkConfig.deduplication.mode === 'timeWindow'">检查指定时间窗口内是否有相同内容</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="bg-white rounded-xl shadow-md border border-gray-100 p-4">
                        <div class="flex flex-col sm:flex-row gap-3 sm:justify-end">
             
                        <button type="submit" 
                                    class="flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-all duration-200 hover:scale-105 shadow-lg hover:shadow-xl">
                                <i data-lucide="save" class="w-4 h-4"></i>
                            保存配置
                        </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 编辑任务标签页 -->
            <div x-show="activeTab === 'edit'" x-cloak class="p-6">
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Bark 通知配置</h3>
                    <p class="text-sm text-gray-600">配置 Bark 推送通知，支持使用 $字段名 作为占位符引用任务执行结果中的数据</p>
                </div>

                <!-- 编辑表单 -->
                <form @submit.prevent="saveTask" class="space-y-6">
                    <!-- 主要2列布局 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 左列：其他所有模块 -->
                        <div class="space-y-6">
                            <!-- 基本信息 -->
                            <div class="space-y-6">
                                <div class="border-b border-slate-200 pb-4">
                                    <h4 class="text-md font-medium text-slate-900 flex items-center">
                                        <i data-lucide="info" class="w-4 h-4 mr-2 text-blue-600"></i>
                                        基本信息
                                    </h4>
                                </div>

                                <!-- 任务名称和描述 -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <!-- 任务名称 -->
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-slate-700">
                                            任务名称 <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" 
                                               x-model="editForm.name"
                                               class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors"
                                               placeholder="请输入任务名称"
                                               required>
                                    </div>

                                    <!-- 任务描述 -->
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-slate-700">任务描述</label>
                                        <textarea x-model="editForm.description"
                                                  rows="1"
                                                  class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors resize-none"
                                                  placeholder="请输入任务描述（可选）"></textarea>
                                    </div>
                                </div>

                                <!-- Cron表达式和常用时间间隔 -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <!-- Cron表达式 -->
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-slate-700">
                                            Cron表达式 <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" 
                                               x-model="editForm.cron_expr"
                                               class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors font-mono text-sm"
                                               placeholder="0 */5 * * * *"
                                               required>
                                        <p class="text-xs text-slate-500">格式: 秒 分 时 日 月 周</p>
                                    </div>

                                    <!-- 常用时间间隔 -->
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-slate-700">常用时间间隔</label>
                                        <div class="space-y-2">
                                            <p class="text-xs text-slate-600">点击快速设置:</p>
                                            <div class="flex flex-wrap gap-1">
                                                <button type="button" @click="setCronExpr('0 * * * * *')" 
                                                        class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                    每分钟
                                                </button>
                                                <button type="button" @click="setCronExpr('0 */10 * * * *')" 
                                                        class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                    10分钟
                                                </button>
                                                <button type="button" @click="setCronExpr('0 */30 * * * *')" 
                                                        class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                    30分钟
                                                </button>
                                                <button type="button" @click="setCronExpr('0 0 * * * *')" 
                                                        class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                    每小时
                                                </button>
                                                <button type="button" @click="setCronExpr('0 0 2 * * *')" 
                                                        class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                    凌晨2点
                                                </button>
                                                <button type="button" @click="setCronExpr('0 0 9 * * 1-5')" 
                                                        class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                    工作日9点
                                                </button>
                                                <button type="button" @click="showCronHelper()" 
                                                        class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition-colors">
                                                    <i data-lucide="help-circle" class="w-3 h-3 inline mr-1"></i>
                                                    自定义
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 时间排除 -->
                                <!-- 启用时间排除 -->
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" 
                                           x-model="editForm.timeExclusionEnabled"
                                           class="w-4 h-4 text-blue-600 bg-slate-100 border-slate-300 rounded focus:ring-blue-500 focus:ring-2">
                                    <label class="text-sm font-medium text-slate-700">启用时间排除</label>
                                </div>

                                <!-- 排除规则 -->
                                <div x-show="editForm.timeExclusionEnabled" class="space-y-4">
                                <div class="bg-slate-50 rounded-xl p-6 space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <i data-lucide="settings" class="w-5 h-5 text-slate-600"></i>
                                            <h5 class="text-sm font-medium text-slate-900">排除规则配置</h5>
                                        </div>
                                        <button type="button" 
                                                @click="addTimeExclusionRule"
                                                class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors text-sm font-medium shadow-sm">
                                            <i data-lucide="plus" class="w-4 h-4"></i>
                                            添加规则
                                        </button>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        <template x-for="(rule, index) in editForm.timeExclusionRules" :key="index">
                                            <div class="bg-white border border-slate-200 rounded-lg p-3">
                                                <!-- 查看模式 -->
                                                <div x-show="!rule._editing">
                                                    <!-- 紧凑的规则显示 -->
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="flex items-center space-x-2">
                                                            <i data-lucide="clock" class="w-3.5 h-3.5 text-blue-600"></i>
                                                            <span class="text-xs font-medium text-slate-700" x-text="getTypeDisplayName(rule.type)"></span>
                                                        </div>
                                                        <!-- 操作按钮 -->
                                                        <div class="flex items-center space-x-1">
                                                            <button type="button" 
                                                                    @click="rule._editing = true; $nextTick(() => lucide.createIcons())"
                                                                    class="inline-flex items-center justify-center p-1 bg-blue-50 text-blue-700 rounded hover:bg-blue-100 transition-colors"
                                                                    title="编辑">
                                                                <i data-lucide="edit-2" class="w-3 h-3"></i>
                                                            </button>
                                                            <button type="button" 
                                                                    @click="removeTimeExclusionRule(index)"
                                                                    class="inline-flex items-center justify-center p-1 bg-red-50 text-red-700 rounded hover:bg-red-100 transition-colors"
                                                                    title="删除">
                                                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- 规则详情展示 -->
                                                    <div class="space-y-1">
                                                        <div class="flex items-center space-x-1 text-xs text-slate-600">
                                                            <i data-lucide="clock" class="w-3 h-3 text-slate-400"></i>
                                                            <span x-text="rule.start_time + ' - ' + rule.end_time"></span>
                                                        </div>
                                                        
                                                        <div x-show="rule.type === 'weekly' && rule.weekdays && rule.weekdays.length > 0" class="flex items-center space-x-1 text-xs text-slate-600">
                                                            <i data-lucide="calendar-days" class="w-3 h-3 text-slate-400"></i>
                                                            <span x-text="getWeekdaysText(rule.weekdays)"></span>
                                                        </div>
                                                        
                                                        <div x-show="rule.type === 'date_range' && rule.start_date && rule.end_date" class="flex items-center space-x-1 text-xs text-slate-600">
                                                            <i data-lucide="calendar-range" class="w-3 h-3 text-slate-400"></i>
                                                            <span x-text="rule.start_date + ' 至 ' + rule.end_date"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 编辑模式 -->
                                                <div x-show="rule._editing">
                                                    <div class="flex items-center justify-between mb-3">
                                                        <div class="flex items-center space-x-1">
                                                            <i data-lucide="edit-3" class="w-3.5 h-3.5 text-blue-600"></i>
                                                            <span class="text-xs font-medium text-slate-700">编辑</span>
                                                        </div>
                                                        <div class="flex items-center space-x-1">
                                                            <button type="button" 
                                                                    @click="rule._editing = false; $nextTick(() => lucide.createIcons())"
                                                                    class="inline-flex items-center justify-center p-1 bg-green-50 text-green-700 rounded hover:bg-green-100 transition-colors"
                                                                    title="确认">
                                                                <i data-lucide="check" class="w-3 h-3"></i>
                                                            </button>
                                                            <button type="button" 
                                                                    @click="rule._editing = false; $nextTick(() => lucide.createIcons())"
                                                                    class="inline-flex items-center justify-center p-1 bg-gray-50 text-gray-700 rounded hover:bg-gray-100 transition-colors"
                                                                    title="取消">
                                                                <i data-lucide="x" class="w-3 h-3"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- 规则配置 -->
                                                    <div class="space-y-2">
                                                        <!-- 规则类型 -->
                                                        <div>
                                                            <label class="block text-xs font-medium text-slate-700 mb-1">类型</label>
                                                            <select x-model="rule.type" 
                                                                    class="w-full px-2 py-1.5 border border-slate-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors bg-white">
                                                                <option value="daily">每日</option>
                                                                <option value="weekly">每周</option>
                                                                <option value="date_range">日期范围</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <!-- 时间设置 -->
                                                        <div class="grid grid-cols-2 gap-2">
                                                            <div>
                                                                <label class="block text-xs font-medium text-slate-700 mb-1">开始</label>
                                                                <input type="time" 
                                                                       x-model="rule.start_time"
                                                                       class="w-full px-2 py-1.5 border border-slate-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors">
                                                            </div>
                                                            <div>
                                                                <label class="block text-xs font-medium text-slate-700 mb-1">结束</label>
                                                                <input type="time" 
                                                                       x-model="rule.end_time"
                                                                       class="w-full px-2 py-1.5 border border-slate-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors">
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- 周几设置（仅weekly类型显示） -->
                                                        <div x-show="rule.type === 'weekly'">
                                                            <label class="block text-xs font-medium text-slate-700 mb-1">星期</label>
                                                            <div class="grid grid-cols-7 gap-1">
                                                                <template x-for="(dayName, dayIndex) in ['日', '一', '二', '三', '四', '五', '六']" :key="dayIndex">
                                                                    <label class="flex flex-col items-center p-1 border border-slate-200 rounded cursor-pointer hover:bg-slate-50 transition-colors text-xs"
                                                                           :class="rule.weekdays && rule.weekdays.includes(dayIndex) ? 'bg-blue-50 border-blue-300' : ''">
                                                                        <input type="checkbox" 
                                                                               :checked="rule.weekdays && rule.weekdays.includes(dayIndex)"
                                                                               @change="toggleWeekday(rule, dayIndex)"
                                                                               class="w-2.5 h-2.5 text-blue-600 bg-slate-100 border-slate-300 rounded focus:ring-blue-500 focus:ring-1 mb-0.5">
                                                                        <span class="text-xs font-medium text-slate-700" x-text="dayName"></span>
                                                                    </label>
                                                                </template>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- 日期范围设置（仅date_range类型显示） -->
                                                        <div x-show="rule.type === 'date_range'" class="grid grid-cols-2 gap-2">
                                                            <div>
                                                                <label class="block text-xs font-medium text-slate-700 mb-1">开始日期</label>
                                                                <input type="date" 
                                                                       x-model="rule.start_date"
                                                                       class="w-full px-2 py-1.5 border border-slate-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors">
                                                            </div>
                                                            <div>
                                                                <label class="block text-xs font-medium text-slate-700 mb-1">结束日期</label>
                                                                <input type="date" 
                                                                       x-model="rule.end_date"
                                                                       class="w-full px-2 py-1.5 border border-slate-300 rounded text-xs focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                        
                                        <div x-show="editForm.timeExclusionRules.length === 0" class="text-center py-8 text-slate-500">
                                            暂无排除规则，点击"添加规则"开始配置
                                        </div>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>
                        <!-- 左列结束 -->

                        <!-- 右列：Python脚本独占 -->
                        <div class="space-y-6">
                            <!-- 脚本内容 -->
                            <div class="space-y-6">
                                <div class="border-b border-slate-200 pb-4">
                                    <h4 class="text-md font-medium text-slate-900 flex items-center">
                                        <i data-lucide="code" class="w-4 h-4 mr-2 text-blue-600"></i>
                                        Python脚本
                                    </h4>
                                </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-slate-700">
                                脚本内容 <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <textarea x-model="editForm.script"
                                          rows="27"
                                          class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors font-mono text-sm"
                                          placeholder="def main():&#10;    print('Hello, AutoBot!')"
                                          required></textarea>
                            </div>
                            
                            <!-- 快速操作 -->
                            <div class="flex flex-wrap gap-2 mt-3">
                                <button type="button" 
                                        @click="validateScript"
                                        class="inline-flex items-center gap-2 px-3 py-1.5 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-colors text-sm font-medium">
                                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                                    验证语法
                                </button>
                                <button type="button" 
                                        @click="insertTemplate"
                                        class="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium">
                                    <i data-lucide="file-plus" class="w-4 h-4"></i>
                                    插入模板
                                </button>
                            </div>
                        </div>
                            </div>

                            <!-- 操作按钮 -->
                            <div class="flex justify-end gap-3 pt-6 border-t border-slate-200">
                                <button type="button" 
                                        @click="resetEditForm"
                                        class="px-4 py-2 border border-slate-300 rounded-xl text-slate-700 hover:bg-slate-50 transition-colors">
                                    重置
                                </button>
                                <button type="submit" 
                                        :disabled="editFormLoading"
                                        class="inline-flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 outline-none transition-colors disabled:opacity-50">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                    <span x-show="!editFormLoading">更新任务</span>
                                    <span x-show="editFormLoading">更新中...</span>
                                </button>
                            </div>
                        </div>
                        <!-- 右列结束 -->
                    </div>
                    <!-- 2列布局结束 -->
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center mr-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600"></i>
                </div>
                <h3 id="modalTitle" class="text-lg font-semibold text-slate-900">确认操作</h3>
            </div>
            <div id="modalBody" class="text-slate-600 mb-6">
                <!-- Modal content -->
            </div>
            <div class="flex justify-end space-x-3">
                <button id="modalCancel" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors">
                    取消
                </button>
                <button id="modalConfirm" class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors">
                    确认
                </button>
            </div>
        </div>
    </div>

    <script>
        function taskDetail() {
            return {
                taskId: window.location.pathname.split('/').pop(),
                activeTab: 'logs',
                task: {},
                logs: [],
                logsLoading: false,
                currentPage: 1,
                pageSize: 5,
                totalLogs: 0,
                totalPages: 0,
                barkKeys: {
                    scriptKeys: [],
                    resultKeys: []
                },
                availableDevices: [],
                selectedDeviceIds: [],
                barkConfig: {
                    title: '',
                    subtitle: '',
                    body: '',
                    level: '',
                    volume: '',
                    badge: '',
                    call: '',
                    autoCopy: '',
                    copy: '',
                    sound: '',
                    icon: '',
                    group: '',
                    ciphertext: '',
                    isArchive: '',
                    url: '',
                    action: '',
                    id: '',
                    delete: '',
                    deduplication: {
                        enabled: false,
                        mode: 'recentN',
                        recent_n: 10,
                        time_window: 60
                    }
                },
                editForm: {
                    name: '',
                    description: '',
                    script: '',
                    cron_expr: '',
                    timeExclusionEnabled: false,
                    timeExclusionRules: []
                },
                editFormLoading: false,

                async init() {
                    // 将实例保存到全局变量，供模态框使用
                    window.taskDetailInstance = this;
                    
                    await this.loadTask();
                    await this.loadLogs();
                    await this.loadBarkKeys();
                    await this.loadAvailableDevices();
                    // 在设备加载完成后再加载配置
                    this.loadBarkConfig();
                },

                async loadTask() {
                    try {
                        const response = await fetch(`/api/tasks/${this.taskId}`);
                        if (response.ok) {
                            this.task = await response.json();
                            // 初始化编辑表单数据
                            this.initEditForm();
                        }
                    } catch (error) {
                        console.error('加载任务失败:', error);
                    }
                },

                initEditForm() {
                    this.editForm.name = this.task.name || '';
                    this.editForm.description = this.task.description || '';
                    this.editForm.script = this.task.script || '';
                    this.editForm.cron_expr = this.task.cron_expr || '';
                    
                    // 初始化时间排除配置
                    if (this.task.time_exclusion_config) {
                        try {
                            const config = JSON.parse(this.task.time_exclusion_config);
                            this.editForm.timeExclusionEnabled = config.enabled || false;
                            this.editForm.timeExclusionRules = config.exclusion_rules || [];
                        } catch (error) {
                            console.error('解析时间排除配置失败:', error);
                            this.editForm.timeExclusionEnabled = false;
                            this.editForm.timeExclusionRules = [];
                        }
                    }
                    
                    // 确保图标正确初始化
                    this.$nextTick(() => {
                        lucide.createIcons();
                    });
                },

                async loadLogs() {
                    try {
                        this.logsLoading = true;
                        const response = await fetch(`/api/tasks/${this.taskId}/logs?page=${this.currentPage}&limit=${this.pageSize}`);
                        if (response.ok) {
                            const data = await response.json();
                            this.logs = data.logs || [];
                            this.totalLogs = data.total || 0;
                            this.totalPages = Math.ceil(this.totalLogs / this.pageSize);
                        }
                    } catch (error) {
                        console.error('加载日志失败:', error);
                    } finally {
                        this.logsLoading = false;
                    }
                },

                changePage(page) {
                    if (page < 1 || page > this.totalPages || page === this.currentPage) return;
                    this.currentPage = page;
                    this.loadLogs();
                },

                get pageNumbers() {
                    const pages = [];
                    const maxVisible = 5;
                    let start = Math.max(1, this.currentPage - Math.floor(maxVisible / 2));
                    let end = Math.min(this.totalPages, start + maxVisible - 1);
                    
                    if (end - start + 1 < maxVisible) {
                        start = Math.max(1, end - maxVisible + 1);
                    }
                    
                    for (let i = start; i <= end; i++) {
                        pages.push(i);
                    }
                    return pages;
                },


                escapeHtmlWithNewlines(text) {
                    if (!text) return '';
                    
                    // 先进行HTML转义
                    const div = document.createElement('div');
                    div.textContent = text;
                    let escaped = div.innerHTML;
                    
                    // 将 \n 替换为真正的换行符
                    escaped = escaped.replace(/\\n/g, '\n');
                    
                    return escaped;
                },

                formatDuration(duration) {
                    if (!duration) return '0ms';
                    if (duration < 1000) return `${duration}ms`;
                    if (duration < 60000) return `${(duration / 1000).toFixed(1)}s`;
                    return `${(duration / 60000).toFixed(1)}min`;
                },


                async deleteTaskLogs() {
                    const self = this;
                    Utils.showConfirm(
                        '删除任务日志',
                        '确定要删除此任务的所有执行日志吗？此操作无法撤销。',
                        async function() {
                            try {
                                const response = await fetch(`/api/tasks/${self.taskId}/logs`, {
                                    method: 'DELETE'
                                });

                                if (response.ok) {
                                    const data = await response.json();
                                    self.showToast(`任务日志已删除 - 共删除 ${data.deleted_count} 条记录`, 'success');
                                    // 重新加载日志列表
                                    await self.loadLogs();
                                } else {
                                    const error = await response.json();
                                    self.showToast('删除日志失败: ' + error.error, 'error');
                                }
                            } catch (error) {
                                console.error('删除日志失败:', error);
                                self.showToast('删除日志失败: ' + error.message, 'error');
                            }
                        }
                    );
                },


                async loadBarkKeys() {
                    try {
                        const response = await fetch(`/api/tasks/${this.taskId}/bark-keys`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            // 只从执行结果中获取 keys
                            this.barkKeys = {
                                keys: data.keys || [],
                                hasExecutionResult: data.has_execution_result || false
                            };
                        }
                    } catch (error) {
                        console.error('加载 Bark Keys 失败:', error);
                    }
                },

                async loadAvailableDevices() {
                    try {
                        const response = await fetch('/api/bark/devices/selection');
                        if (response.ok) {
                            const data = await response.json();
                            this.availableDevices = data.devices || [];
                            
                            // 不再默认选择任何设备，让用户手动选择
                        }
                    } catch (error) {
                        console.error('加载设备列表失败:', error);
                    }
                },

                loadBarkConfig() {
                    if (this.task.bark_config) {
                        try {
                            const config = JSON.parse(this.task.bark_config);
                            
                            // 特别处理去重配置，确保正确合并
                            const deduplicationConfig = {
                                enabled: false,
                                mode: 'recentN',
                                recent_n: 10,
                                time_window: 60,
                                ...config.deduplication
                            };
                            
                            // 合并配置，但特别处理去重部分
                            this.barkConfig = { 
                                ...this.barkConfig, 
                                ...config,
                                deduplication: deduplicationConfig
                            };
                            
                            // 处理设备选择，确保设备ID都是数字类型
                            if (config.selected_device_ids) {
                                this.selectedDeviceIds = config.selected_device_ids.map(id => parseInt(id, 10));
                            } else if (config.device_key) {
                                // 兼容旧的配置格式，根据 device_key 找到对应的设备ID
                                const device = this.availableDevices.find(d => d.device_key === config.device_key);
                                if (device) {
                                    this.selectedDeviceIds = [parseInt(device.id, 10)];
                                }
                            }
                            
                            console.log('Loaded Bark config:', this.barkConfig);
                        } catch (error) {
                            console.error('解析 Bark 配置失败:', error);
                        }
                    }
                },

                async saveBarkConfig() {
                    try {
                        // 准备配置数据，确保设备ID和去重参数都是正确的数字类型
                        const configToSave = {
                            ...this.barkConfig,
                            selected_device_ids: this.selectedDeviceIds.map(id => parseInt(id, 10)),
                            deduplication: {
                                enabled: this.barkConfig.deduplication.enabled,
                                mode: this.barkConfig.deduplication.mode,
                                recent_n: parseInt(this.barkConfig.deduplication.recent_n, 10) || 10,
                                time_window: parseInt(this.barkConfig.deduplication.time_window, 10) || 60
                            }
                        };

                        console.log('Saving Bark config:', configToSave);
                        console.log('JSON string to send:', JSON.stringify(configToSave));

                        const response = await fetch(`/api/tasks/${this.taskId}/bark-config`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                bark_config: JSON.stringify(configToSave)
                            }),
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Save response:', result);
                            this.showToast('Bark 配置保存成功', 'success');
                            
                            // 保存后重新加载任务信息以验证保存结果
                            await this.loadTask();
                            this.loadBarkConfig();
                        } else {
                            const error = await response.json();
                            console.error('Save error:', error);
                            this.showToast('保存失败: ' + error.error, 'error');
                        }
                    } catch (error) {
                        console.error('保存 Bark 配置失败:', error);
                        this.showToast('保存失败: ' + error.message, 'error');
                    }
                },

                async testBarkConfig() {
                    // 创建测试数据
                    const testResult = { 
                        title: '测试标题', 
                        body: '测试内容', 
                        group: '测试分组' 
                    };
                    
                    // 模拟占位符替换
                    const testConfig = { ...this.barkConfig };
                    for (const [key, value] of Object.entries(testConfig)) {
                        if (typeof value === 'string' && value.includes('$')) {
                            testConfig[key] = value.replace(/\$(\w+)/g, (match, placeholder) => {
                                return testResult[placeholder] || match;
                            });
                        }
                    }

                    this.showToast('测试配置已生成，请查看控制台', 'info');
                    console.log('测试配置:', testConfig);
                },

                async runTask() {
                    try {
                        const response = await fetch(`/api/tasks/${this.taskId}/run`, {
                            method: 'POST',
                        });

                        if (response.ok) {
                            this.showToast('任务已开始执行', 'success');
                            setTimeout(() => {
                                this.loadLogs();
                            }, 1000);
                        } else {
                            const error = await response.json();
                            this.showToast('执行任务失败: ' + error.error, 'error');
                        }
                    } catch (error) {
                        console.error('执行任务失败:', error);
                        this.showToast('执行任务失败: ' + error.message, 'error');
                    }
                },

                // Toast 通知功能
                showToast(message, type = 'info', duration = 3000) {
                    // 移除现有的toast
                    const existingToast = document.getElementById('app-toast');
                    if (existingToast) {
                        existingToast.remove();
                    }

                    // 创建新的toast
                    const toast = document.createElement('div');
                    toast.id = 'app-toast';
                    toast.className = `fixed top-4 right-4 z-50 max-w-sm w-full transform transition-all duration-300 ease-in-out`;
                    
                    const bgColor = {
                        'success': 'bg-green-50 border-green-200 text-green-800',
                        'error': 'bg-red-50 border-red-200 text-red-800',
                        'warning': 'bg-amber-50 border-amber-200 text-amber-800',
                        'info': 'bg-blue-50 border-blue-200 text-blue-800'
                    }[type] || 'bg-blue-50 border-blue-200 text-blue-800';

                    const iconName = {
                        'success': 'check-circle',
                        'error': 'x-circle',
                        'warning': 'alert-triangle',
                        'info': 'info'
                    }[type] || 'info';

                    toast.innerHTML = `
                        <div class="border rounded-xl p-4 shadow-lg ${bgColor}">
                            <div class="flex items-start">
                                <i data-lucide="${iconName}" class="w-5 h-5 mt-0.5 mr-3 flex-shrink-0"></i>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium">${message}</p>
                                </div>
                                <button onclick="this.closest('#app-toast').remove()" class="ml-3 text-current opacity-70 hover:opacity-100">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    // 添加到页面
                    document.body.appendChild(toast);
                    
                    // 初始化图标
                    lucide.createIcons();

                    // 显示动画
                    setTimeout(() => {
                        toast.style.transform = 'translateX(0)';
                        toast.style.opacity = '1';
                    }, 10);

                    // 自动隐藏
                    if (duration > 0) {
                        setTimeout(() => {
                            if (toast && toast.parentNode) {
                                toast.style.transform = 'translateX(100%)';
                                toast.style.opacity = '0';
                                setTimeout(() => {
                                    if (toast && toast.parentNode) {
                                        toast.remove();
                                    }
                                }, 300);
                            }
                        }, duration);
                    }
                },

                formatDate(dateString) {
                    if (!dateString) return '未知';
                    return new Date(dateString).toLocaleString('zh-CN');
                },

                async copyToClipboard(text, event) {
                    try {
                        await Utils.copyToClipboard(text);
                        // 简单的成功提示
                        if (event && event.target) {
                            const button = event.target.closest('button');
                            if (button) {
                                const originalContent = button.innerHTML;
                                button.innerHTML = '<svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                                setTimeout(() => {
                                    button.innerHTML = originalContent;
                                }, 1000);
                            }
                        }
                    } catch (error) {
                        console.error('复制失败:', error);
                        this.showToast('复制失败，请手动复制: ' + text, 'error');
                    }
                },

                // ==================== 编辑表单相关方法 ====================

                setCronExpr(expression) {
                    this.editForm.cron_expr = expression;
                    // this.showToast('Cron表达式已设置: ' + expression, 'success', 2000);
                },

                async validateScript() {
                    const script = this.editForm.script.trim();
                    
                    if (!script) {
                        this.showToast('脚本内容不能为空', 'error');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/validate-script', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ script }),
                        });
                        
                        const result = await response.json();
                        
                        if (result.valid) {
                            this.showToast('脚本语法正确', 'success');
                        } else {
                            this.showToast('脚本语法错误: ' + result.error, 'error');
                        }
                    } catch (error) {
                        this.showToast('验证失败: ' + error.message, 'error');
                    }
                },

                insertTemplate() {
                    // 显示模板选择模态框
                    this.showTemplateModal();
                },

                showTemplateModal() {
                    const modal = document.getElementById('templateModal');
                    modal.classList.remove('hidden');
                },

                closeTemplateModal() {
                    const modal = document.getElementById('templateModal');
                    modal.classList.add('hidden');
                },

                selectTemplate(templateType) {
                    const templates = {
                        'basic': `def main():
    """基础模板"""
    print("Hello, AutoBot!")
    print({"bark_key":"value"})`,
                        
                        'web_request': `import requests

def main():
    """Web请求模板"""
    try:
        response = requests.get('https://api.example.com/data')
        response.raise_for_status()
        data = response.json()
        print(f"获取数据成功: {data}")
    except requests.RequestException as e:
        print(f"请求失败: {e}")`
                    };
                    
                    if (templates[templateType]) {
                        this.editForm.script = templates[templateType];
                        // this.showToast('模板已插入', 'success');
                    }
                    
                    this.closeTemplateModal();
                },

                addTimeExclusionRule() {
                    const newRule = {
                        type: 'daily',
                        start_time: '22:00',
                        end_time: '06:00',
                        weekdays: [],
                        start_date: '',
                        end_date: '',
                        _editing: true  // 新规则默认进入编辑模式
                    };
                    
                    this.editForm.timeExclusionRules.push(newRule);
                    // this.showToast('已添加新的时间排除规则', 'success');
                    
                    // 重新初始化图标
                    this.$nextTick(() => {
                        lucide.createIcons();
                    });
                },

                removeTimeExclusionRule(index) {
                    if (index >= 0 && index < this.editForm.timeExclusionRules.length) {
                        this.editForm.timeExclusionRules.splice(index, 1);
                        // this.showToast('时间排除规则已删除', 'success');
                        
                        // 重新初始化图标
                        this.$nextTick(() => {
                            lucide.createIcons();
                        });
                    }
                },

                getWeekdaysText(weekdays) {
                    if (!weekdays || weekdays.length === 0) return '';
                    const weekdayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                    return weekdays.map(day => weekdayNames[day]).join('、');
                },

                getTypeDisplayName(type) {
                    const typeNames = {
                        'daily': '每日',
                        'weekly': '每周',
                        'date_range': '日期范围'
                    };
                    return typeNames[type] || type;
                },

                toggleWeekday(rule, dayIndex) {
                    if (!rule.weekdays) {
                        rule.weekdays = [];
                    }
                    
                    const index = rule.weekdays.indexOf(dayIndex);
                    if (index > -1) {
                        rule.weekdays.splice(index, 1);
                    } else {
                        rule.weekdays.push(dayIndex);
                    }
                },

                // ==================== Cron 帮助器相关方法 ====================

                showCronHelper() {
                    const modal = document.getElementById('cronHelperModal');
                    modal.classList.remove('hidden');
                    
                    // 初始化构建器
                    this.initializeCronBuilder();
                    
                    // 重新初始化图标
                    lucide.createIcons();
                },

                closeCronHelper() {
                    const modal = document.getElementById('cronHelperModal');
                    modal.classList.add('hidden');
                },

                initializeCronBuilder() {
                    // 绑定更改事件
                    const selectors = ['#cronSeconds', '#cronMinutes', '#cronHours', '#cronDays', '#cronMonths', '#cronWeekdays'];
                    selectors.forEach(selector => {
                        const element = document.querySelector(selector);
                        if (element) {
                            element.addEventListener('change', () => this.updateCronBuilder());
                        }
                    });
                    
                    // 初始更新
                    this.updateCronBuilder();
                },

                updateCronBuilder() {
                    const seconds = document.getElementById('cronSeconds')?.value || '0';
                    const minutes = document.getElementById('cronMinutes')?.value || '*';
                    const hours = document.getElementById('cronHours')?.value || '*';
                    const days = document.getElementById('cronDays')?.value || '*';
                    const months = document.getElementById('cronMonths')?.value || '*';
                    const weekdays = document.getElementById('cronWeekdays')?.value || '*';
                    
                    const cronExpression = `${seconds} ${minutes} ${hours} ${days} ${months} ${weekdays}`;
                    const generatedCronElement = document.getElementById('generatedCron');
                    if (generatedCronElement) {
                        generatedCronElement.textContent = cronExpression;
                    }
                },

                applyCronFromBuilder() {
                    const generatedCronElement = document.getElementById('generatedCron');
                    if (generatedCronElement) {
                        const expression = generatedCronElement.textContent;
                        this.editForm.cron_expr = expression;
                        
                        // 关闭模态框
                        this.closeCronHelper();
                        
                        // 显示成功提示
                        // this.showToast('Cron表达式已应用: ' + expression, 'success', 2000);
                    }
                },

                resetEditForm() {
                    this.initEditForm();
                    this.showToast('表单已重置', 'success');
                },

                async saveTask() {
                    if (!this.validateEditForm()) {
                        return;
                    }
                    
                    this.editFormLoading = true;
                    
                    try {
                        const formData = {
                            name: this.editForm.name.trim(),
                            description: this.editForm.description.trim(),
                            script: this.editForm.script,
                            cron_expr: this.editForm.cron_expr.trim(),
                            time_exclusion_config: JSON.stringify({
                                enabled: this.editForm.timeExclusionEnabled,
                                exclusion_rules: this.editForm.timeExclusionRules
                            })
                        };
                        
                        const response = await fetch(`/api/tasks/${this.taskId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData),
                        });
                        
                        if (response.ok) {
                            this.showToast('任务更新成功', 'success');
                            // 重新加载任务数据
                            await this.loadTask();
                        } else {
                            const error = await response.json();
                            this.showToast('更新任务失败: ' + error.error, 'error');
                        }
                    } catch (error) {
                        console.error('保存任务失败:', error);
                        this.showToast('保存任务失败: ' + error.message, 'error');
                    } finally {
                        this.editFormLoading = false;
                    }
                },

                validateEditForm() {
                    if (!this.editForm.name.trim()) {
                        this.showToast('任务名称不能为空', 'error');
                        return false;
                    }
                    
                    if (!this.editForm.cron_expr.trim()) {
                        this.showToast('Cron表达式不能为空', 'error');
                        return false;
                    }
                    
                    // 验证Cron表达式格式
                    const cronParts = this.editForm.cron_expr.trim().split(/\s+/);
                    if (cronParts.length !== 6) {
                        this.showToast('Cron表达式格式错误，应包含6个部分（秒 分 时 日 月 周）', 'error');
                        return false;
                    }
                    
                    if (!this.editForm.script.trim()) {
                        this.showToast('脚本内容不能为空', 'error');
                        return false;
                    }
                    
                    if (!this.editForm.script.includes('def main():')) {
                        this.showToast('脚本必须包含 main() 函数定义', 'error');
                        return false;
                    }
                    
                    return true;
                }
            }
        }
        
        // 初始化 Lucide 图标
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            
            // Mobile menu toggle
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                });
            }
        });

    </script>

    <style>
        /* 自定义滚动条样式 */
        .log-output-scrollable {
            scrollbar-width: thin;
            scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
        }
        
        .log-output-scrollable::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .log-output-scrollable::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 4px;
        }
        
        .log-output-scrollable::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        
        .log-output-scrollable::-webkit-scrollbar-thumb:hover {
            background-color: rgba(156, 163, 175, 0.7);
        }
        
        /* 暗色主题的滚动条 */
        .log-output-dark::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.3);
        }
        
        .log-output-dark::-webkit-scrollbar-thumb:hover {
            background-color: rgba(156, 163, 175, 0.5);
        }
    </style>

    <!-- Cron Helper Modal -->
    <div id="cronHelperModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-slate-200">
                <h3 class="text-lg font-semibold text-slate-900">Cron表达式帮助</h3>
                <button onclick="document.getElementById('cronHelperModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                <!-- Cron Builder -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Builder Form -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-slate-900">Cron表达式构建器</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">秒</label>
                                    <select id="cronSeconds" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="0">0 (整点)</option>
                                        <option value="*/5">*/5 (每5秒)</option>
                                        <option value="*/10">*/10 (每10秒)</option>
                                        <option value="*/15">*/15 (每15秒)</option>
                                        <option value="*/30">*/30 (每30秒)</option>
                                        <option value="*">* (每秒)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">分钟</label>
                                    <select id="cronMinutes" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="*">* (每分钟)</option>
                                        <option value="0">0 (整点)</option>
                                        <option value="*/5">*/5 (每5分钟)</option>
                                        <option value="*/10">*/10 (每10分钟)</option>
                                        <option value="*/15">*/15 (每15分钟)</option>
                                        <option value="*/30">*/30 (每30分钟)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">小时</label>
                                    <select id="cronHours" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="*">* (每小时)</option>
                                        <option value="0">0 (午夜)</option>
                                        <option value="*/2">*/2 (每2小时)</option>
                                        <option value="*/6">*/6 (每6小时)</option>
                                        <option value="*/12">*/12 (每12小时)</option>
                                        <option value="9">9 (上午9点)</option>
                                        <option value="12">12 (中午12点)</option>
                                        <option value="18">18 (下午6点)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">日期</label>
                                    <select id="cronDays" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="*">* (每天)</option>
                                        <option value="1">1 (每月1号)</option>
                                        <option value="15">15 (每月15号)</option>
                                        <option value="*/7">*/7 (每7天)</option>
                                        <option value="1,15">1,15 (每月1号和15号)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">月份</label>
                                    <select id="cronMonths" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="*">* (每月)</option>
                                        <option value="1">1 (1月)</option>
                                        <option value="*/3">*/3 (每季度)</option>
                                        <option value="*/6">*/6 (每半年)</option>
                                        <option value="1,4,7,10">1,4,7,10 (季度月)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">星期</label>
                                    <select id="cronWeekdays" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="*">* (每天)</option>
                                        <option value="0">0 (周日)</option>
                                        <option value="1">1 (周一)</option>
                                        <option value="1-5">1-5 (工作日)</option>
                                        <option value="0,6">0,6 (周末)</option>
                                        <option value="1,3,5">1,3,5 (周一三五)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-700">生成的表达式:</span>
                                    <button onclick="window.taskDetailInstance.updateCronBuilder()" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                        更新
                                    </button>
                                </div>
                                <div id="generatedCron" class="font-mono text-sm bg-white p-2 rounded border">0 */5 * * * *</div>
                            </div>
                            
                            <button onclick="window.taskDetailInstance.applyCronFromBuilder()" 
                                    class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                应用表达式
                            </button>
                        </div>
                    </div>
                    
                    <!-- Reference Guide -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-slate-900">参考指南</h4>
                        
                        <div class="space-y-3">
                            <div>
                                <h5 class="text-sm font-medium text-slate-700 mb-2">字段说明</h5>
                                <div class="text-xs space-y-1 bg-slate-50 p-3 rounded-lg font-mono">
                                    <div>秒 (0-59)</div>
                                    <div>分 (0-59)</div>
                                    <div>时 (0-23)</div>
                                    <div>日 (1-31)</div>
                                    <div>月 (1-12)</div>
                                    <div>周 (0-6, 0=周日)</div>
                                </div>
                            </div>
                            
                            <div>
                                <h5 class="text-sm font-medium text-slate-700 mb-2">特殊字符</h5>
                                <div class="text-xs space-y-1">
                                    <div><code class="bg-slate-100 px-1 rounded">*</code> - 匹配任何值</div>
                                    <div><code class="bg-slate-100 px-1 rounded">?</code> - 不指定值（日期和星期字段）</div>
                                    <div><code class="bg-slate-100 px-1 rounded">-</code> - 范围，如 1-5</div>
                                    <div><code class="bg-slate-100 px-1 rounded">,</code> - 列表，如 1,3,5</div>
                                    <div><code class="bg-slate-100 px-1 rounded">/</code> - 间隔，如 */5</div>
                                </div>
                            </div>
                            
                            <div>
                                <h5 class="text-sm font-medium text-slate-700 mb-2">常用示例</h5>
                                <div class="text-xs space-y-1">
                                    <div><code class="bg-slate-100 px-1 rounded text-xs">0 0 12 * * *</code> - 每天中午12点</div>
                                    <div><code class="bg-slate-100 px-1 rounded text-xs">0 15 10 * * *</code> - 每天上午10:15</div>
                                    <div><code class="bg-slate-100 px-1 rounded text-xs">0 0 9 * * 1-5</code> - 工作日上午9点</div>
                                    <div><code class="bg-slate-100 px-1 rounded text-xs">0 0 0 1 * *</code> - 每月第一天</div>
                                    <div><code class="bg-slate-100 px-1 rounded text-xs">0 0 2 * * 0</code> - 每周日凌晨2点</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Selection Modal -->
    <div id="templateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
            <div class="p-6 border-b border-slate-200">
                <h3 class="text-lg font-semibold text-slate-900">选择代码模板</h3>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="grid grid-cols-1 gap-3">
                    <button type="button" 
                            onclick="window.taskDetailInstance.selectTemplate('basic')" 
                            class="text-left p-4 border border-slate-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-colors">
                        <h4 class="font-medium text-slate-900 mb-2">基础模板</h4>
                        <pre class="text-xs text-slate-600 bg-slate-50 p-2 rounded overflow-x-auto">def main():
    """基础模板"""
    print("Hello, AutoBot!")
    print({"bark_key":"value"})</pre>
                    </button>
                    
                    <button type="button" 
                            onclick="window.taskDetailInstance.selectTemplate('web_request')" 
                            class="text-left p-4 border border-slate-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-colors">
                        <h4 class="font-medium text-slate-900 mb-2">Web请求模板</h4>
                        <pre class="text-xs text-slate-600 bg-slate-50 p-2 rounded overflow-x-auto">import requests

def main():
    """Web请求模板"""
    try:
        response = requests.get('https://api.example.com/data')
        response.raise_for_status()
        data = response.json()
        print(f"获取数据成功: {data}")
    except requests.RequestException as e:
        print(f"请求失败: {e}")</pre>
                    </button>
                </div>
            </div>
            <div class="p-6 border-t border-slate-200 flex justify-end">
                <button onclick="document.getElementById('templateModal').classList.add('hidden')" 
                        class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors">
                    取消
                </button>
            </div>
        </div>
    </div>
</body>
</html>
