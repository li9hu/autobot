{{ define "task_form.html" }}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }} - AutoBot</title>
    
    <!-- TailwindCSS -->
    <script src="/static/js/tailwind.js"></script>
    <!-- Lucide Icons -->
    <script src="/static/js/lucide.js"></script>
    <!-- Inter Font -->
    <link href="/static/css/inter-font.css" rel="stylesheet">
    <!-- CodeMirror -->
    <link rel="stylesheet" href="/static/css/codemirror.min.css">
    <link rel="stylesheet" href="/static/css/codemirror-github.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .CodeMirror {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 14px;
            line-height: 1.5;
        }
        .CodeMirror-focused {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                    </div>
                    <h1 class="text-xl font-semibold text-slate-900">AutoBot</h1>
                </div>
                <div class="hidden sm:flex space-x-8">
                    <a href="/" class="text-slate-600 hover:text-slate-900 font-medium pb-4 px-1 border-b-2 border-transparent hover:border-slate-300 transition-colors">任务管理</a>
                    <a href="/logs" class="text-slate-600 hover:text-slate-900 font-medium pb-4 px-1 border-b-2 border-transparent hover:border-slate-300 transition-colors">执行日志</a>
                    <a href="/bark" class="text-slate-600 hover:text-slate-900 font-medium pb-4 px-1 border-b-2 border-transparent hover:border-slate-300 transition-colors">Bark管理</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center mb-4">
                <a href="/" class="text-slate-400 hover:text-slate-600 mr-3">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <h2 class="text-2xl font-bold text-slate-900">
                    {{ if .task }}编辑任务{{ else }}创建任务{{ end }}
                </h2>
            </div>
            <p class="text-slate-600">
                {{ if .task }}修改现有任务的配置和脚本{{ else }}创建新的定时执行任务{{ end }}
            </p>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200">
            <form id="taskForm" class="space-y-6 p-6">
                <!-- 主要2列布局 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 左列：其他所有模块 -->
                    <div class="space-y-6">
                        <!-- 基本信息 -->
                        <div class="space-y-6">
                            <div class="border-b border-slate-200 pb-4">
                                <h4 class="text-md font-medium text-slate-900 flex items-center">
                                    <i data-lucide="info" class="w-4 h-4 mr-2 text-blue-600"></i>
                                    基本信息
                                </h4>
                            </div>

                            <!-- 任务名称和描述 -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <!-- 任务名称 -->
                                <div class="space-y-2">
                                    <label for="taskName" class="block text-sm font-medium text-slate-700">
                                        任务名称 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" 
                                           id="taskName" 
                                           name="name"
                                           class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors"
                                           placeholder="请输入任务名称"
                                           {{ if .task }}value="{{ .task.Name }}"{{ end }}
                                           required>
                                    <div class="invalid-feedback hidden text-sm text-red-600 mt-1"></div>
                                </div>

                                <!-- 任务描述 -->
                                <div class="space-y-2">
                                    <label for="taskDescription" class="block text-sm font-medium text-slate-700">任务描述</label>
                                    <textarea id="taskDescription" 
                                              name="description"
                                              rows="1"
                                              class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors resize-none"
                                              placeholder="请输入任务描述（可选）">{{ if .task }}{{ .task.Description }}{{ end }}</textarea>
                                </div>
                            </div>

                            <!-- Cron表达式和常用时间间隔 -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <!-- Cron表达式 -->
                                <div class="space-y-2">
                                    <label for="cronExpr" class="block text-sm font-medium text-slate-700">
                                        Cron表达式 <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" 
                                           id="cronExpr" 
                                           name="cron_expr"
                                           class="w-full px-3 py-2 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors font-mono text-sm"
                                           placeholder="0 */5 * * * *"
                                           {{ if .task }}value="{{ .task.CronExpr }}"{{ end }}
                                           required>
                                    <div class="invalid-feedback hidden text-sm text-red-600 mt-1"></div>
                                    <p class="text-xs text-slate-500">格式: 秒 分 时 日 月 周</p>
                                </div>

                                <!-- 常用时间间隔 -->
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-slate-700">常用时间间隔</label>
                                    <div class="space-y-2">
                                        <p class="text-xs text-slate-600">点击快速设置:</p>
                                        <div class="flex flex-wrap gap-1">
                                            <button type="button" onclick="setCronExpr('0 * * * * *')" 
                                                    class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                每分钟
                                            </button>
                                            <button type="button" onclick="setCronExpr('0 */10 * * * *')" 
                                                    class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                10分钟
                                            </button>
                                            <button type="button" onclick="setCronExpr('0 */30 * * * *')" 
                                                    class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                30分钟
                                            </button>
                                            <button type="button" onclick="setCronExpr('0 0 * * * *')" 
                                                    class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                每小时
                                            </button>
                                            <button type="button" onclick="setCronExpr('0 0 2 * * *')" 
                                                    class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                凌晨2点
                                            </button>
                                            <button type="button" onclick="setCronExpr('0 0 9 * * 1-5')" 
                                                    class="px-2 py-1 text-xs bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 transition-colors">
                                                工作日9点
                                            </button>
                                            <button type="button" onclick="showCronHelper()" 
                                                    class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition-colors">
                                                <i data-lucide="help-circle" class="w-3 h-3 inline mr-1"></i>
                                                自定义
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 时间排除 -->
                            <!-- 启用时间排除 -->
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" 
                                       id="timeExclusionEnabled" 
                                       class="w-4 h-4 text-blue-600 bg-slate-100 border-slate-300 rounded focus:ring-blue-500 focus:ring-2">
                                <label for="timeExclusionEnabled" class="text-sm font-medium text-slate-700">启用时间排除</label>
                            </div>

                            <!-- 排除规则 -->
                            <div id="timeExclusionRules" class="space-y-4 hidden">
                                <div class="bg-slate-50 rounded-xl p-6 space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <i data-lucide="settings" class="w-5 h-5 text-slate-600"></i>
                                            <h5 class="text-sm font-medium text-slate-900">排除规则配置</h5>
                                        </div>
                                        <button type="button" 
                                                id="addRuleBtn"
                                                class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors text-sm font-medium shadow-sm">
                                            <i data-lucide="plus" class="w-4 h-4"></i>
                                            添加规则
                                        </button>
                                    </div>
                                    
                                    <div id="rulesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        <!-- Rules will be dynamically added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 左列结束 -->

                    <!-- 右列：Python脚本独占 -->
                    <div class="space-y-6">
                        <!-- 脚本内容 -->
                        <div class="space-y-6">
                            <div class="border-b border-slate-200 pb-4">
                                <h4 class="text-md font-medium text-slate-900 flex items-center">
                                    <i data-lucide="code" class="w-4 h-4 mr-2 text-blue-600"></i>
                                    Python脚本
                                </h4>
                            </div>

                            <div class="space-y-2">
                                <label for="taskScript" class="block text-sm font-medium text-slate-700">
                                    脚本内容 <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <textarea id="taskScript" 
                                              name="script"
                                              class="hidden"
                                              required>{{ if .task }}{{ .task.Script }}{{ end }}</textarea>
                                    <div id="scriptEditor" class="border border-slate-300 rounded-xl"></div>
                                </div>
                                <div class="invalid-feedback hidden text-sm text-red-600 mt-1"></div>
                                
                                <!-- Quick Actions -->
                                <div class="flex flex-wrap gap-2 mt-3">
                                    <button type="button" 
                                            id="validateBtn"
                                            class="inline-flex items-center gap-2 px-3 py-1.5 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-colors text-sm font-medium">
                                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                                        验证语法
                                    </button>
                                    <button type="button" 
                                            id="insertTemplateBtn"
                                            class="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium">
                                        <i data-lucide="file-plus" class="w-4 h-4"></i>
                                        插入模板
                                    </button>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="flex flex-col sm:flex-row justify-between gap-4 pt-6 border-t border-slate-200">
                                <a href="/" class="inline-flex items-center gap-2 px-4 py-2 border border-slate-300 rounded-xl text-slate-700 hover:bg-slate-50 transition-colors">
                                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                    返回列表
                                </a>
                                <div class="flex gap-3">
                                    <button type="button" 
                                            id="resetBtn"
                                            class="px-4 py-2 border border-slate-300 rounded-xl text-slate-700 hover:bg-slate-50 transition-colors">
                                        重置
                                    </button>
                                    <button type="submit" 
                                            id="submitBtn"
                                            class="inline-flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 outline-none transition-colors">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        {{ if .task }}更新任务{{ else }}创建任务{{ end }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- 右列结束 -->
                    </div>
                    <!-- 2列布局结束 -->
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span class="text-slate-700">处理中...</span>
        </div>
    </div>

    <!-- Cron Helper Modal -->
    <div id="cronHelperModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-slate-200">
                <h3 class="text-lg font-semibold text-slate-900">Cron表达式帮助</h3>
                <button onclick="closeCronHelper()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                <!-- Cron Builder -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Builder Form -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-slate-900">Cron表达式构建器</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">秒</label>
                                    <select id="cronSeconds" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="0">0 (整点)</option>
                                        <option value="*/5">*/5 (每5秒)</option>
                                        <option value="*/10">*/10 (每10秒)</option>
                                        <option value="*/15">*/15 (每15秒)</option>
                                        <option value="*/30">*/30 (每30秒)</option>
                                        <option value="*">* (每秒)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">分钟</label>
                                    <select id="cronMinutes" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="*">* (每分钟)</option>
                                        <option value="0">0 (整点)</option>
                                        <option value="*/5">*/5 (每5分钟)</option>
                                        <option value="*/10">*/10 (每10分钟)</option>
                                        <option value="*/15">*/15 (每15分钟)</option>
                                        <option value="*/30">*/30 (每30分钟)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">小时</label>
                                    <select id="cronHours" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="*">* (每小时)</option>
                                        <option value="0">0 (午夜)</option>
                                        <option value="*/2">*/2 (每2小时)</option>
                                        <option value="*/6">*/6 (每6小时)</option>
                                        <option value="*/12">*/12 (每12小时)</option>
                                        <option value="9">9 (上午9点)</option>
                                        <option value="12">12 (中午12点)</option>
                                        <option value="18">18 (下午6点)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">日期</label>
                                    <select id="cronDays" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="*">* (每天)</option>
                                        <option value="1">1 (每月1号)</option>
                                        <option value="15">15 (每月15号)</option>
                                        <option value="*/7">*/7 (每7天)</option>
                                        <option value="1,15">1,15 (每月1号和15号)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">月份</label>
                                    <select id="cronMonths" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="*">* (每月)</option>
                                        <option value="1">1 (1月)</option>
                                        <option value="*/3">*/3 (每季度)</option>
                                        <option value="*/6">*/6 (每半年)</option>
                                        <option value="1,4,7,10">1,4,7,10 (季度月)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">星期</label>
                                    <select id="cronWeekdays" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="*">* (每天)</option>
                                        <option value="0">0 (周日)</option>
                                        <option value="1">1 (周一)</option>
                                        <option value="1-5">1-5 (工作日)</option>
                                        <option value="0,6">0,6 (周末)</option>
                                        <option value="1,3,5">1,3,5 (周一三五)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-700">生成的表达式:</span>
                                    <button onclick="updateCronBuilder()" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                        更新
                                    </button>
                                </div>
                                <div id="generatedCron" class="font-mono text-sm bg-white p-2 rounded border">0 */5 * * * *</div>
                            </div>
                            
                            <button onclick="applyCronFromBuilder()" 
                                    class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                应用表达式
                            </button>
                        </div>
                    </div>
                    
                    <!-- Reference Guide -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-slate-900">参考指南</h4>
                        
                        <div class="space-y-3">
                            <div>
                                <h5 class="text-sm font-medium text-slate-700 mb-2">字段说明</h5>
                                <div class="text-xs space-y-1 bg-slate-50 p-3 rounded-lg font-mono">
                                    <div>秒 (0-59)</div>
                                    <div>分 (0-59)</div>
                                    <div>时 (0-23)</div>
                                    <div>日 (1-31)</div>
                                    <div>月 (1-12)</div>
                                    <div>周 (0-6, 0=周日)</div>
                                </div>
                            </div>
                            
                            <div>
                                <h5 class="text-sm font-medium text-slate-700 mb-2">特殊字符</h5>
                                <div class="text-xs space-y-1">
                                    <div><code class="bg-slate-100 px-1 rounded">*</code> - 匹配任何值</div>
                                    <div><code class="bg-slate-100 px-1 rounded">?</code> - 不指定值（日期和星期字段）</div>
                                    <div><code class="bg-slate-100 px-1 rounded">-</code> - 范围，如 1-5</div>
                                    <div><code class="bg-slate-100 px-1 rounded">,</code> - 列表，如 1,3,5</div>
                                    <div><code class="bg-slate-100 px-1 rounded">/</code> - 间隔，如 */5</div>
                                </div>
                            </div>
                            
                            <div>
                                <h5 class="text-sm font-medium text-slate-700 mb-2">常用示例</h5>
                                <div class="text-xs space-y-1">
                                    <div><code class="bg-slate-100 px-1 rounded text-xs">0 0 12 * * *</code> - 每天中午12点</div>
                                    <div><code class="bg-slate-100 px-1 rounded text-xs">0 15 10 * * *</code> - 每天上午10:15</div>
                                    <div><code class="bg-slate-100 px-1 rounded text-xs">0 0 9 * * 1-5</code> - 工作日上午9点</div>
                                    <div><code class="bg-slate-100 px-1 rounded text-xs">0 0 0 1 * *</code> - 每月第一天</div>
                                    <div><code class="bg-slate-100 px-1 rounded text-xs">0 0 2 * * 0</code> - 每周日凌晨2点</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="/static/js/jquery.min.js"></script>
    <!-- CodeMirror -->
    <script src="/static/js/codemirror.min.js"></script>
    <script src="/static/js/codemirror-python.min.js"></script>
    <!-- Custom JS -->
    <script src="/static/js/app.js"></script>
    <script src="/static/js/task_form.js"></script>
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
                </div>
                <h3 id="modalTitle" class="text-lg font-semibold text-slate-900">确认操作</h3>
            </div>
            <div id="modalBody" class="text-slate-600 mb-6">
                <!-- Modal content -->
            </div>
            <div class="flex justify-end space-x-3">
                <button id="modalCancel" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors">
                    取消
                </button>
                <button id="modalConfirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    确认
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Pass task data to JavaScript
        {{ if .task }}
        window.taskData = {
            time_exclusion_config: '{{ .task.TimeExclusionConfig }}'
        };
        {{ else }}
        window.taskData = null;
        {{ end }}
    </script>
</body>
</html>
{{ end }}